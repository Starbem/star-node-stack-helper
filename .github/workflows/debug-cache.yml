name: Debug Cache Issues

on:
  workflow_dispatch:

jobs:
  debug-cache:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug file structure
        run: |
          echo "=== Current directory structure ==="
          pwd
          ls -la
          echo ""
          echo "=== libs directory structure ==="
          ls -la libs/
          echo ""
          echo "=== star-node-stack-helper directory structure ==="
          ls -la libs/star-node-stack-helper/
          echo ""
          echo "=== Checking for lock files ==="
          find . -name "*.lock*" -o -name "pnpm-lock.yaml" -o -name "package-lock.json" -o -name "yarn.lock"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.6.2

      - name: Setup Node.js without cache
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Test pnpm without cache
        run: |
          cd libs/star-node-stack-helper
          echo "Testing pnpm install without cache..."
          pnpm install --frozen-lockfile
          echo "✅ pnpm install successful without cache"

      - name: Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: libs/star-node-stack-helper/pnpm-lock.yaml

      - name: Test pnpm with cache
        run: |
          cd libs/star-node-stack-helper
          echo "Testing pnpm install with cache..."
          pnpm install --frozen-lockfile
          echo "✅ pnpm install successful with cache"
